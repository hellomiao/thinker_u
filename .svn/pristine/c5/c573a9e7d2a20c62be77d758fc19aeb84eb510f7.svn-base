<?php
/**
 * Created by PhpStorm.
 * User: yangchunrun
 * Date: 17/5/24
 * Time: 下午2:29
 * 从国家统计局抓取行政区域代码,省市区县乡镇四级
 */

namespace console\controllers;


use app\admin\models\District;
use yii\console\Controller;

class DistrictController extends Controller
{

    public $defaultAction = 'run';

    public function curl($url)
    {
        $headers['CLIENT-IP'] = '202.103.229.40';
        $headers['X-FORWARDED-FOR'] = '202.103.229.40';
        $headers['Accept'] = 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8';
        $headers['User-Agent'] = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36';
        $headerArr = array();
        foreach ($headers as $n => $v) {
            $headerArr[] = $n . ':' . $v;
        }
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_HTTPHEADER, $headerArr);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_HEADER, 1);
        $rs = curl_exec($ch);
        curl_close($ch);
        return $rs;

    }

    public function actionRun()
    {
        header("Content-type:text/html;charset=utf-8");
        $district = new District();
        set_time_limit(0);
        $con = $this->curl('http://www.stats.gov.cn/tjsj/tjbz/tjyqhdmhcxhfdm/2016/index.html');
        $con = iconv('gbk', 'utf-8', $con);
        //采集省
        $sheng = preg_match_all('/href=\'(\d*)\.html\'>([^<]*)/i', $con, $arr);

        //循环省
        foreach ($arr[1] as $k => $v) {
            //将省加入数据库
            $district->isNewRecord = true;
            $district->name = $arr[2][$k];
            $district->level = 1;
            $district->parent_id = 0;
            $district->save();
            $id = $district->id;
            $district->id = 0;

            //采集市（如果是直辖市 则采集区 11 12 31 50 为直辖市
            $con = $this->curl('http://www.stats.gov.cn/tjsj/tjbz/tjyqhdmhcxhfdm/2016/' . $v . '.html');
            $con = iconv('gbk', 'utf-8', $con);
            $shi = preg_match_all('/href=\'' . $v . '\/(\d*)\.html\'>([^<]*)/i', $con, $arr1);

            //循环市
            foreach ($arr1[1] as $k1 => $v1) {
                //判断奇偶 如果是奇数 则为实际市
                if ($k1 % 2 == 1) {
                    //判断如果是省直辖县级行政区划 则属于市
                    $district->isNewRecord = true;
                    $district->name = $arr1[2][$k1] != '市辖区' ? $arr1[2][$k1] : $arr[2][$k];
                    $district->level = 2;
                    $district->parent_id = $id;
                    $district->save();
                    $id1 = $district->id;
                    $district->id = 0;

                    //采集县
                    $n = str_replace($v, '', $v1);
                    $con = $this->curl("http://www.stats.gov.cn/tjsj/tjbz/tjyqhdmhcxhfdm/2016/{$v}/{$v1}.html");
                    $con = iconv('gbk', 'utf-8', $con);
                    $shi = preg_match_all('/href=\'' . $n . '\/(\d*)\.html\'>([^<]*)/i', $con, $arr2);

                    foreach ($arr2[1] as $k2 => $v2) {
                        if ($k2 % 2 == 1) {
                            $district->isNewRecord = true;
                            $district->name = $arr2[2][$k2];
                            $district->level = 3;
                            $district->parent_id = $id1;
                            $district->save();
                            $id2 = $district->id;
                            $district->id = 0;

                            //采集乡镇
                            $nk = str_replace($v1, '', $v2);
                            $con = $this->curl("http://www.stats.gov.cn/tjsj/tjbz/tjyqhdmhcxhfdm/2016/{$v}/{$n}/{$v2}.html");
                            $con = iconv('gbk', 'utf-8', $con);
                            $shi = preg_match_all('/href=\'' . $nk . '\/(\d*)\.html\'>([^<]*)/i', $con, $arr3);
                            foreach ($arr3[1] as $k3 => $v3) {
                                if ($k3 % 2 == 1) {
                                    $district->isNewRecord = true;
                                    $district->name = $arr3[2][$k3];
                                    $district->level = 4;
                                    $district->parent_id = $id2;
                                    $id3 = $district->save();
                                    $district->id = 0;
                                }
                            }

                        }
                    }


                }

                sleep(1);
            }


        }


    }
}