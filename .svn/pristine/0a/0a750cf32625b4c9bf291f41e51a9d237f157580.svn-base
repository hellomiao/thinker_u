<?php
/**
 * Created by PhpStorm.
 * User: yangchunrun
 * Date: 17/4/19
 * Time: 下午6:44
 */

namespace app\home\api;



use app\api\components\BaseApi;
use app\home\models\User;
use yii\base\Exception;

class Login extends BaseApi
{

    public  $needToken =false;

    protected function rules()
    {
        return [
            'username' => ['required' => true,'name' => '手机号', "message" => "请输入正确的帐号"],
            'password' => [ 'min' => 6, 'max' => 16, 'required' => true, 'name' => '密码', "message" => "请输入正确的密码"],
        ];
    }

    public function run()
    {
        $params = $this->params;
        $model = User::find()->where(['username' => $params['username']])->one();
        if(!$model){
            throw  new Exception('帐号不存在',1003);
        }
        $res = $model->validatePassword($params['password']);
        if (!$res) {
            throw  new Exception('用户名或者密码错误',1003);
        } else {
            $model->scenario = 'login';
            $access_token = $model->createToken();
            $model->access_token = $access_token;
            $model->last_login_time=time();
            $model->save();
            return $this->formatData(['access_token' => $access_token]);
        }
    }

}