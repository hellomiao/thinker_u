<?php
/**
 * Created by PhpStorm.
 * User: yangchunrun
 * Date: 17/4/19
 * Time: 下午6:44
 */

namespace app\admin\api;


use app\admin\models\Admin;
use app\admin\models\Line;
use app\admin\models\Notice;
use app\admin\models\NoticeLine;
use app\api\components\BaseApi;
use app\base\models\Config;
use yii\base\Exception;
use yii\helpers\ArrayHelper;

class ListNotice extends BaseApi
{
    protected function rules()
    {
        return [
            'access_token' => ['required' => true, 'name' => 'access_token', "message" => "access_token是必需的"],
            'page' => ['type' => 'number', 'name' => '页数', "message" => "请输入正确的页数"],
            'status' => ['name' => '状态'],
        ];
    }

    public function run()
    {

        $params = $this->params;
        $page = $params['page'] ? $params['page'] : 1;
        $pageSize = 10;
        $offset = ($page - 1) * $pageSize;
        $admin = new Admin();
        $user = $admin->getUserByToken($params['access_token']);
        if (!$user) {
            return $this->formatData([], 1005, 'token不正确!');
        }
        $where['cid'] = $user->cid;
        if (isset($params['status'])) {
            if (is_numeric($params['status'])) {
                $where['status'] = $params['status'];
            } else if ($params['status'] == 'no') {
                $where['status'] = [2, 5];
            } else if ($params['status'] == 'waiting') {
                $where['status'] = [0, 3];
            }
        }
        $count=Notice::find()->where($where)->andWhere(['<>','status',4])->count();
        $hasmore = $page*$pageSize<$count;
        $notice = Notice::find()->where($where)->andWhere(['<>','status',4])->offset($offset)->limit($pageSize)->orderBy('created_at desc')->all();
        $data = [];
        foreach ($notice as $key => $val) {
            $data[$key]['notice_id'] = $val->id;
            $data[$key]['title'] = $val->getLineName() . '|' . $val->getReason()[$val->reason];
            $data[$key]['start_time'] = $val->start_time;
            $data[$key]['end_time'] = $val->end_time;
            $data[$key]['range'] = $val->getXiaoqu();
            $data[$key]['line1'] = $val->getLineName();
            $data[$key]['line2'] = $val->getLine2Name();
            $data[$key]['reason'] = $val->getReason()[$val->reason];
            $data[$key]['line'] = $val->getLine3Name();
            $data[$key]['taiqu'] = $val->getLine4Name();
            $data[$key]['note'] = $val->note;
            $data[$key]['info'] = $val->info;
            $data[$key]['status'] = $val->status;
            $data[$key]['statusTxt'] = $user->group_id==5?$val->getStatus()[$val->status]:$val->getStatus1()[$val->status];
            $data[$key]['created_at'] = date("Y-m-d", $val->created_at);
        }

        return $this->formatData(['list'=>$data,'hasmore'=>$hasmore,'total'=>$count]);


    }

}