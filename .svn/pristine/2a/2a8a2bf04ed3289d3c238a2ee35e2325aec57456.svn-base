<?php
/**
 * Created by PhpStorm.
 * User: yangchunrun
 * Date: 17/7/19
 * Time: 下午1:57
 */

namespace app\home\api;


use app\api\components\BaseApi;
use app\base\lib\Utils;
use app\home\models\Delivery;
use app\home\models\Driver;

use app\home\models\Order;
use yii\base\Exception;
use yii\helpers\ArrayHelper;


class GetOrder extends BaseApi
{
    protected function rules()
    {
        return [
            'status' => ['name' => '状态', "info" => "1配送中 2已完成"],

        ];
    }

    public function run()
    {

        $params = $this->params;
        $date = date("Y-m-d");
        $platform_id = $this->user->platform_id;
        $driver = Driver::find()->where(['user_id' => $this->user->id])->one();
        $driver_id = $driver->id;
        $delivery = Delivery::find()->where(['platform_id' => $platform_id, 'driver_id' => $driver_id, 'delivery_date' => $date])->all();
        $ids=[];
        foreach($delivery as $key=>$val){
            array_push($ids,$val->id);
        }
        $query = Order::find()->where(['platform_id' => $platform_id, 'delivery_id' => $ids, 'status' => $params['status']]);
        $count1 = Order::find()->where(['platform_id' => $platform_id, 'delivery_id' => $ids, 'status' => 1])->count();
        $count2 = Order::find()->where(['platform_id' => $platform_id, 'delivery_id' => $ids, 'status' => 2])->count();
        $listTmp = $query->orderBy('order_num asc')->all();
        $data = [];
        foreach ($listTmp as $key => $val) {
            $data[$key]['order_id'] = $val->id;
            $data[$key]['name'] = $val->customer->name;
            $data[$key]['num'] = $val->num;
            $data[$key]['delivery_time'] = $val->delivery_time;
            $data[$key]['note'] = $val->note;
            $data[$key]['distance'] = $val->distance;
            if($params['status']==1) {
                $duration = $val->duration;
                $data[$key]['dstatus']=$val->start_time>0?2:1;
            }else{
                $duration=$val->end_time-$val->start_time;
                $data[$key]['dstatus']=3;
            }
            $data[$key]['duration'] = Utils::sec2time($duration);
            $data[$key]['tel'] = $val->customer->tel1;
            $data[$key]['longitude'] = $val->customer->longitude;
            $data[$key]['latitude'] = $val->customer->latitude;
            $data[$key]['address'] = $val->customer->address;
        }
        return $this->formatData(['goingNum'=>$count1,'finishNum'=>$count2,'list'=>$data]);


    }

}
