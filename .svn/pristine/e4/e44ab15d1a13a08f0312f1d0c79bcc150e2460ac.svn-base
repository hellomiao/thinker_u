<?php
/**
 * Created by PhpStorm.
 * User: yangchunrun
 * Date: 17/7/24
 * Time: 上午11:44
 */

namespace app\ajax\controllers;


use app\home\models\Customer;
use app\home\models\Driver;
use app\home\models\Order;
use app\home\models\User;

class ApiController extends BaseController
{
    public function actionCustomer()
    {


        $platform_id = \Yii::$app->request->post('platform_id');
        $keywords = \Yii::$app->request->post('keywords');
        $data = [];
        $data['delivery'] = Customer::find()->where(['platform_id' => $platform_id, 'status' => 0])->count();
        $data['sleep'] = Customer::find()->where(['platform_id' => $platform_id, 'status' => 1])->count();
        $query = Customer::find()->where(['platform_id' => $platform_id]);
        if ($keywords) {
            $query->andWhere(['or', ['like', 'code', $keywords], ['like', 'name', $keywords]]);
        }
        $listTmp = $query->all();
        $data['items'] = [];
        foreach ($listTmp as $key => $val) {
            $data['items'][$key]['id'] = $val->id;
            $data['items'][$key]['number'] = $val->code;
            $data['items'][$key]['name'] = $val->name;
            $data['items'][$key]['type'] = $val->status == 1 ? 2 : 1;
            $data['items'][$key]['location'] = ['longitude' => $val->longitude, 'latitude' => $val->latitude];
        }
        unset($listTmp);
        $this->response($data);


    }

    public function actionOrder()
    {
        $platform_id = \Yii::$app->request->post('platform_id');
        $where['platform_id'] = $platform_id;
        $where['status'] = 0;
        if (date("G") >= 16) {
            $tomorrow = date("Y-m-d", strtotime("+1 day"));
            $where['delivery_date'] = $tomorrow;
        } else {
            $today = date("Y-m-d");
            $where['delivery_date'] = $today;
        }

        $data = [];

        $user = User::find()->where(['platform_id' => $platform_id])->all();
        foreach ($user as $k => $v) {
            $orders = Order::find()->where($where)->andWhere(['user_id' => $v->id])->all();
            if ($orders) {
                $data[$k]['id'] = $v->id;
                $data[$k]['name'] = $v->username;
                $data[$k]['items'] = [];
                foreach ($orders as $key => $val) {
                    $data[$k]['items'][$key]['order_id'] = $val->id;
                    $data[$k]['items'][$key]['name'] = $val->customer->name;
                    $data[$k]['items'][$key]['address'] = $val->customer->address;
                    $data[$k]['items'][$key]['state'] = $val->status;
                    $data[$k]['items'][$key]['delivery_time'] = $val->delivery_time;
                    $data[$k]['items'][$key]['cargo_num'] = $val->num;
                    $data[$k]['items'][$key]['remarks'] = $val->note;
                    $data[$k]['items'][$key]['location'] = ['longitude' => $val->customer->longitude,
                        'latitude' => $val->customer->latitude];
                }
            }
        }


        $this->response($data);

    }

    public function actionDriver()
    {
        $data = [];
        $platform_id = \Yii::$app->request->post('platform_id');
        $data['items'] = [];
        $listTmp = Driver::find()->where(['platform_id' => $platform_id])->all();
        foreach ($listTmp as $key => $val) {
            $data['items'][$key]['id'] = $val->id;
            $data['items'][$key]['name'] = $val->username;
            $carInfo = [];
            $carInfo[] = ['id' => 1, 'name' => '车牌号', 'value' => $val->car_number];
            $carInfo[] = ['id' => 2, 'name' => '车型号', 'value' => $val->car_type];
            $carInfo[] = ['id' => 3, 'name' => '车辆内控', 'value' => $val->inner_size];
            $carInfo[] = ['id' => 4, 'name' => '车辆外厢', 'value' => $val->outer_size];
            $data['items'][$key]['carInfo'] = $carInfo;
            $data['items'][$key]['goodsInfo'] = $val->getGoods();
        }
        unset($listTmp);
        $this->response($data);
    }


    public function actionAddDeliver()
    {
        $platform_id = \Yii::$app->request->post('platform_id');
        $driver_id = \Yii::$app->request->post('driver_id');
        $orders = \Yii::$app->request->post('orders');
        foreach ($orders as $v) {
            Order::updateAll(['order_num' => $v['order_num']]);

        }
    }

    public function actionTest()
    {

        return $this->renderPartial('test');
    }

}