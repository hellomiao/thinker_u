<?php
/**
 * Created by PhpStorm.
 * User: yangchunrun
 * Date: 17/4/19
 * Time: 下午6:44
 */

namespace app\admin\api;


use app\admin\models\Admin;
use app\admin\models\Customer;
use app\api\components\BaseApi;
use app\base\models\Config;

class Login extends BaseApi
{
    protected function rules()
    {
        return [
            'username' => ['required' => true,'name' => '手机号', "message" => "请输入正确的帐号"],
            'password' => ['type' => 'pwd', 'min' => 6, 'max' => 16, 'required' => true, 'name' => '密码', "message" => "请输入正确的密码"],
        ];
    }

    public function run()
    {
        $params = $this->params;
        $model = Admin::find()->where(['username' => $params['username']])->one();
        if(!$model){
            return $this->formatData([], 1003, '帐号不存在');
        }
        $res = $model->validatePassword($params['password']);
        if (!$res) {
            return $this->formatData([], 1003, '用户名或者密码错误');
        } else {
            $model->scenario = 'login';
            $access_token = $model->createToken();
            $model->access_token = $access_token;
            $model->last_login_time=time();
            $model->save();
            $group='';
            if($model->cid>0) {
                $cu = Customer::findOne($model->cid);
            }
            if(in_array($model->group_id,[4,6])){
                $group='isManager';
            }else if($model->group_id==7){
                $group='isDevice'; //设备账号
                return $this->formatData(['access_token' => $access_token,'group'=>$group,'name'=>$model->xiaoqu->name,'cname'=>$cu->name]);
            }else if($model->group_id==5){
                $group='isPublisher'; //发布账号
            }

            return $this->formatData(['access_token' => $access_token,'group'=>$group,'name'=>$cu->name]);
        }
    }

}