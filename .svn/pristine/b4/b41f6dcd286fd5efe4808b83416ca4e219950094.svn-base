<?php
/**
 * Created by PhpStorm.
 * User: yangchunrun
 * Date: 17/4/19
 * Time: 下午6:44
 */

namespace app\admin\api;


use app\admin\models\Admin;
use app\admin\models\Notice;
use app\admin\models\Xiaoqu;
use app\api\components\BaseApi;
use app\base\models\Config;

class PowerNotice extends BaseApi
{
    protected function rules()
    {
        return [
            'access_token' => ['required' => true, 'name' => 'access_token', "message" => "access_token是必需的"],
        ];
    }

    public function run()
    {
        $params = $this->params;
        $admin = new Admin();
        $user = $admin->getUserByToken($params['access_token']);
        if (!$user) {
            return $this->formatData([], 1005, 'token不正确!');
        }
        $query =Notice::find()->from('{{%notice}} as t')->where(['t.cid'=>$user->cid,'t.status'=>[1,3]]);
        if($user->group_id==7){
            $xiaoqu=Xiaoqu::findOne($user->xiaoqu_id);
            $line_id4 = $xiaoqu->line_id4;
            $query->leftJoin('{{%notice_line}} as l','t.id =  l.nid');
            $query->andWhere(['l.line_id4'=>$line_id4]);
        }

        $notice =$query->all();
        $list=[];
        foreach($notice as $key=>$val) {
            $list[$key]['id'] = $val->id;
            $list[$key]['line'] = $val->getLineName();
            $list[$key]['village'] = $val->getXiaoqu();
            $list[$key]['start_time'] = $val->start_time;
            $list[$key]['end_time'] = $val->end_time;
        }
        return $this->formatData($list);
    }

}